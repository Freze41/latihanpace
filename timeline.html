<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rama ‚Äî Session Timeline + Mini Map</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg-main:#050510;
  --bg-card:#0b0b18;
  --accent-cyan:#00eaff;
  --accent-magenta:#ff4dff;
  --accent-lime:#b0ff4d;
  --text-soft:#d6e6ff;
  --border-soft:#242444;
}
*{box-sizing:border-box;}
body{
  margin:0;
  padding:0;
  background:radial-gradient(circle at 10% 0%,#11112a 0,#050510 45%,#02020a 100%);
  font-family:'Rajdhani',sans-serif;
  color:var(--text-soft);
}

/* HEADER */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 16px;
  background:linear-gradient(90deg,#05050c,#0c0c1c,#05050c);
  border-bottom:1px solid #161633;
  color:var(--accent-cyan);
  text-shadow:0 0 10px var(--accent-cyan);
  font-family:'Orbitron',sans-serif;
}
header .left{
  display:flex;align-items:center;gap:10px;
}
header .icon{font-size:24px;}
header .title-main{font-size:18px;letter-spacing:0.16em;}
header .title-sub{font-size:10px;letter-spacing:0.18em;color:#9fdcff;text-transform:uppercase;}
header .back-btn{
  font-size:11px;
  color:#9feaff;
  text-decoration:none;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #2a2a42;
  background:rgba(5,5,20,0.7);
  cursor:pointer;
}
header .back-btn:hover{
  border-color:#00eaff;
  box-shadow:0 0 8px #00eaff80;
}

/* CONTAINER */
main{
  max-width:780px;
  margin:16px auto 40px;
  padding:0 12px;
}

/* TIMELINE HEADER */
.timeline-header{
  margin-bottom:8px;
}
.timeline-header h1{
  margin:0;
  font-size:18px;
  letter-spacing:0.08em;
  text-transform:uppercase;
  color:#e8ffff;
}
.timeline-header p{
  margin:4px 0 0;
  font-size:12px;
  color:#a8b8ff;
}

/* FILTER STRIP (PLAN & SHOE) */
.filter-strip{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:8px;
  margin:8px 0 10px;
  font-size:11px;
}
.filter-label{
  color:#9fa8ff;
  text-transform:uppercase;
  letter-spacing:0.12em;
  font-size:10px;
}
.filter-chip{
  padding:4px 10px;
  border-radius:999px;
  border:1px solid #2a2a44;
  background:#060612;
  color:#d6e6ff;
  cursor:pointer;
}
.filter-chip.filter-active{
  border-color:#00eaff;
  box-shadow:0 0 6px #00eaff80;
  color:#eaffff;
}

/* SUMMARY BADGES */
.summary-strip{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:6px 0 14px;
  font-size:11px;
}
.badge{
  padding:4px 10px;
  border-radius:999px;
  border:1px solid #2a2a44;
  background:#060612;
}
.badge-strong{border-color:#b0ff4d;background:#0c1810;color:#eaffd6;}
.badge-warn{border-color:#ffb84d;background:#201308;color:#ffe8c4;}
.badge-plan{border-color:#4ddfff80;background:#061520;color:#d6f7ff;}

/* TIMELINE WRAP */
.timeline{
  position:relative;
  margin-top:6px;
  padding-left:18px;
}
.timeline::before{
  content:"";
  position:absolute;
  left:11px;
  top:0;
  bottom:0;
  width:2px;
  background:linear-gradient(to bottom,#00eaff,#ff4dff);
  opacity:0.5;
}

/* ITEM */
.item{
  position:relative;
  margin-bottom:16px;
}
.item:last-child{margin-bottom:6px;}
.item-dot{
  position:absolute;
  left:-1px;
  top:6px;
  width:14px;height:14px;
  border-radius:50%;
  border:2px solid #00eaff;
  background:#050510;
  box-shadow:0 0 10px #00eaffaa;
}
.item-dot.easy{border-color:#4ddfff;}
.item-dot.tempo{border-color:#ff8dff;}
.item-dot.interval{border-color:#ff6a7f;}
.item-dot.long{border-color:#b0ff4d;}
.item-dot.rest{border-color:#b0b0cc;box-shadow:none;}
.item-dot.strength{border-color:#ffc857;}

.card{
  margin-left:14px;
  background:var(--bg-card);
  border-radius:12px;
  border:1px solid var(--border-soft);
  padding:9px 10px 10px;
  box-shadow:0 0 12px #000000c0;
}
.card-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}
.date-label{
  font-size:11px;
  color:#9feaff;
  text-transform:uppercase;
  letter-spacing:0.12em;
}
.type-label{
  font-size:13px;
  font-weight:600;
}
.type-label span{
  font-size:11px;
  opacity:0.8;
  margin-left:4px;
}
.type-easy{color:#4ddfff;}
.type-tempo{color:#ff8dff;}
.type-interval{color:#ff6a7f;}
.type-long{color:#b0ff4d;}
.type-rest{color:#b0b0cc;}
.type-strength{color:#ffc857;}

.pill{
  font-size:10px;
  padding:2px 7px;
  border-radius:999px;
  border:1px solid #2a2a44;
  background:#060612;
  color:#cfd7ff;
}
.pill-key{border-color:#ffb84d;background:#201308;color:#ffe8c4;}
.pill-support{border-color:#4ddfff80;background:#061520;color:#d6f7ff;}
.pill-rest{border-color:#b0b0cc;background:#1a1a26;color:#f0f0ff;}

/* BODY */
.card-body{
  margin-top:6px;
  font-size:12px;
  color:#e8ffff;
}
.target{
  font-size:11px;
  color:#a8dfff;
}
.row{
  margin-top:4px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  font-size:11px;
}
.row span{white-space:nowrap;}
.label{color:#9fa8ff;}

.comment{
  margin-top:6px;
  font-size:11px;
  color:#cfd7ff;
  background:#15152a;
  border-left:3px solid #00eaff;
  border-radius:4px;
  padding:4px 6px;
}

/* SPLITS PER KM ‚Äî KM terpisah, lightsaber bar sendiri */
.splits{
  margin-top:6px;
  font-size:11px;
}
.splits-title{
  color:#9fa8ff;
  text-transform:uppercase;
  letter-spacing:0.08em;
  margin-bottom:2px;
}
.splits-row{
  display:flex;
  flex-direction:column;
  gap:4px;
}

/* Satu baris split: KM | BAR | pace */
.splits-line{
  display:flex;
  align-items:center;
  gap:8px;
}

.splits-km{
  width:52px;
  text-align:right;
  font-weight:600;
  color:#f5f7ff;
}

.splits-pace{
  font-variant-numeric:tabular-nums;
  color:#d6e6ff;
  font-size:10px;
  opacity:0.85;
}

/* Shell garis */
.splits-bar-shell{
  flex:1;
  position:relative;
  height:10px;
  border-radius:999px;
  background:#060612;
  border:1px solid #2a2a44;
  overflow:hidden;
  box-shadow:0 0 4px rgba(0,0,0,0.6);
}

/* Isi garis lightsaber */
.splits-bar-core{
  position:absolute;
  top:1px;
  bottom:1px;
  left:0;
  width:var(--bar-fill,100%);
  border-radius:999px;
  background:
    linear-gradient(
      120deg,
      rgba(0,0,0,0.4) 0%,
      var(--saber-color, #00eaff) 18%,
      #ffffff 50%,
      var(--saber-color, #00eaff) 82%,
      rgba(0,0,0,0.4) 100%
    );
  background-size:200% 100%;
  animation:splitSaber 1.8s linear infinite;
  opacity:0.95;
  mix-blend-mode:screen;
}

/* Band warna: FAST = biru, MID = ungu, SLOW = merah pekat */
.split-band-fast{
  --saber-color:#00aaff;
  border-color:rgba(0,170,255,0.9);
  box-shadow:0 0 10px rgba(0,170,255,0.9);
}
.split-band-mid{
  --saber-color:#b000ff;
  border-color:rgba(176,0,255,0.9);
  box-shadow:0 0 10px rgba(176,0,255,0.8);
}
.split-band-slow{
  --saber-color:#ff0033; /* merah pekat */
  border-color:rgba(255,0,51,0.9);
  box-shadow:0 0 10px rgba(255,0,51,0.9);
}

/* Animasi garis berjalan */
@keyframes splitSaber{
  0%{background-position:0% 50%;}
  100%{background-position:200% 50%;}
}

/* MINI MAP + CONTROLS */
.mini-map-wrap{
  margin-top:6px;
}
.mini-map{
  margin-top:4px;
  height:150px;
  width:100%;
  position:relative;
  border-radius:10px;
  overflow:hidden;
  background:#050510;
  box-shadow:0 0 10px #00eaff55;
  z-index:0;
}
.map-placeholder{
  font-size:11px;
  color:#9399c8;
  padding:6px 4px;
}
.map-controls{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:4px;
  gap:8px;
}
.map-btn{
  font-size:10px;
  padding:3px 9px;
  border-radius:999px;
  border:1px solid #2a2a44;
  background:#060612;
  color:#9feaff;
  cursor:pointer;
}
.map-btn[disabled]{
  opacity:0.4;
  cursor:default;
}
.map-btn:hover:not([disabled]){
  border-color:#00eaff;
  box-shadow:0 0 6px #00eaff66;
}
.map-status{
  font-size:10px;
  color:#a8b8ff;
}

/* EMPTY */
.empty{
  margin-top:20px;
  font-size:13px;
  color:#b3c0ff;
  background:#060612;
  border:1px dashed #2a2a44;
  border-radius:10px;
  padding:10px 12px;
}

/* FOOTER */
footer{
  font-size:10px;
  text-align:center;
  color:#8c9aff;
  padding:12px 0 18px;
  opacity:0.8;
}

/* MODAL PILIH PLAN */
.plan-modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(5,5,20,0.8);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.plan-modal-overlay.show{display:flex;}
.plan-modal{
  background:#0b0b18;
  border-radius:14px;
  padding:14px 16px 12px;
  border:1px solid #2a2a44;
  box-shadow:0 0 22px #00eaff80;
  max-width:320px;
  width:90%;
  color:#e8ffff;
}
.plan-modal-title{
  font-family:'Orbitron',sans-serif;
  font-size:13px;
  letter-spacing:0.12em;
  text-transform:uppercase;
  color:#00eaff;
}
.plan-modal-desc{
  font-size:11px;
  color:#cfd7ff;
  margin-top:4px;
  margin-bottom:10px;
}
.plan-options{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:8px;
}
.plan-option-btn{
  width:100%;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #2a2a44;
  background:#060612;
  color:#d6e6ff;
  font-size:11px;
  cursor:pointer;
  text-align:left;
}
.plan-option-btn span.label-main{
  font-weight:600;
  display:block;
}
.plan-option-btn span.label-sub{
  font-size:10px;
  opacity:0.76;
  display:block;
}
.plan-option-btn:hover{
  border-color:#00eaff;
  box-shadow:0 0 8px #00eaff80;
}
.plan-modal-close{
  margin-top:2px;
  width:100%;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid #404060;
  background:transparent;
  color:#cfd7ff;
  font-size:11px;
  cursor:pointer;
}
</style>
</head>
<body>

<header>
  <div class="left">
    <div class="icon">üßµ</div>
    <div>
      <div class="title-main">RAMA TRAINING THREADS</div>
      <div class="title-sub">SESSION TIMELINE + MINI MAP</div>
    </div>
  </div>
  <button id="backToCalendar" class="back-btn">‚Üê Kembali ke Kalender</button>
</header>

<main>
  <div class="timeline-header">
    <h1>Session Timeline</h1>
    <p>Feed semua sesi yang sudah kamu log ‚Äî lengkap dengan mini map & animasi rute ala ‚Äúvideo‚Äù, tapi warna tetap cyberpunk.</p>
  </div>

  <!-- FILTER PLAN -->
  <div class="filter-strip">
    <span class="filter-label">PLAN</span>
    <button class="filter-chip filter-active" data-filter="all">Semua</button>
    <button class="filter-chip" data-filter="5K_DEC">5K Desember</button>
    <button class="filter-chip" data-filter="10K_JAN">10K Januari</button>
  </div>

  <!-- FILTER SEPATU (dibangun dinamis lewat JS) -->
  <div class="filter-strip" id="shoeFilterStrip"></div>

  <div id="summary" class="summary-strip"></div>

  <div id="timeline" class="timeline"></div>

  <div id="emptyState" class="empty" style="display:none;">
    Belum ada sesi yang terekam untuk filter ini.<br>
    Log dulu latihan di kalender plan (5K Desember / 10K Januari), lalu balik ke sini.  
    Strava boleh keren, tapi ‚ÄúRama App‚Äù ini nggak kalah lah üòè
  </div>
</main>

<footer>
  Data diambil dari localStorage:  
  <code>runnaUltraLogs_5K_DEC</code> / <code>runnaUltraLogs_10K_JAN</code> (plus route & splits jika ada).  
  Edit log & upload TCX tetap dari masing-masing kalender plan.
</footer>

<!-- MODAL PILIH PLAN -->
<div id="planModal" class="plan-modal-overlay">
  <div class="plan-modal">
    <div class="plan-modal-title">Pilih Kalender Plan</div>
    <div class="plan-modal-desc">Mau balik ke kalender yang mana?</div>
    <div class="plan-options">
      <button class="plan-option-btn" data-target="plan5k.html">
        <span class="label-main">5K Desember</span>
        <span class="label-sub">Fokus: 5K sub-30 ‚Ä¢ 3‚Äì31 Des</span>
      </button>
      <button class="plan-option-btn" data-target="Plan10k.html">
        <span class="label-main">10K Januari</span>
        <span class="label-sub">Fokus: 10K progress ‚Ä¢ 1‚Äì31 Jan</span>
      </button>
    </div>
    <button id="planModalClose" class="plan-modal-close">Tutup</button>
  </div>
</div>

<script>
/* ===== META PLAN ===== */
const PLANS = [
  {
    id:'5K_DEC',
    label:'5K Desember',
    short:'5K Des',
    monthLabel:'Des',
    logsKey:'runnaUltraLogs_5K_DEC',
    routesKey:'runnaUltraRoutes_5K_DEC',
    order:0
  },
  {
    id:'10K_JAN',
    label:'10K Januari',
    short:'10K Jan',
    monthLabel:'Jan',
    logsKey:'runnaUltraLogs_10K_JAN',
    routesKey:'runnaUltraRoutes_10K_JAN',
    order:1
  }
];

/* ===== PLAN 5K DESEMBER (ringkas) ===== */
const PLAN_5K_DES = [
  // WEEK 1 (3‚Äì9)
  {day:3,  type:'Easy',     title:'Easy Run 30 menit',           pace:'7:10‚Äì7:40', block:'support'},
  {day:4,  type:'Strength', title:'Strength 25‚Äì35 menit',        pace:'-',         block:'support'},
  {day:5,  type:'Interval', title:'Interval 6√ó200m',             pace:'5:00‚Äì5:20', block:'key'},
  {day:6,  type:'Easy',     title:'Recovery Run',                pace:'7:20‚Äì7:50', block:'support'},
  {day:7,  type:'Tempo',    title:'Tempo 15 menit',              pace:'6:15‚Äì6:25', block:'key'},
  {day:8,  type:'Rest',     title:'Rest Day',                    pace:'-',         block:'rest'},
  {day:9,  type:'Interval', title:'Interval 4√ó400m',             pace:'5:20‚Äì5:30', block:'key'},
  // WEEK 2 (10‚Äì16)
  {day:10, type:'Long',     title:'Long Run 8‚Äì10 km',            pace:'7:00‚Äì7:30', block:'key'},
  {day:11, type:'Strength', title:'Strength 20‚Äì30 menit',        pace:'-',         block:'support'},
  {day:12, type:'Tempo',    title:'Steady 25‚Äì30 menit',          pace:'6:30‚Äì6:50', block:'key'},
  {day:13, type:'Easy',     title:'Easy Run',                    pace:'7:10‚Äì7:40', block:'support'},
  {day:14, type:'Tempo',    title:'Tempo 2√ó8 menit',             pace:'6:00‚Äì6:15', block:'key'},
  {day:15, type:'Rest',     title:'Rest Day',                    pace:'-',         block:'rest'},
  {day:16, type:'Interval', title:'Test 1 km',                   pace:'5:10‚Äì5:40', block:'key'},
  // WEEK 3 (17‚Äì23)
  {day:17, type:'Easy',     title:'Easy Shakeout',               pace:'7:10‚Äì7:40', block:'support'},
  {day:18, type:'Interval', title:'Interval 5√ó400m',             pace:'5:10‚Äì5:25', block:'key'},
  {day:19, type:'Rest',     title:'Rest Day',                    pace:'-',         block:'rest'},
  {day:20, type:'Tempo',    title:'Steady 30 menit',             pace:'6:30‚Äì6:50', block:'key'},
  {day:21, type:'Long',     title:'Long Run 9‚Äì10 km',            pace:'7:00‚Äì7:40', block:'key'},
  {day:22, type:'Strength', title:'Strength 25‚Äì35 menit',        pace:'-',         block:'support'},
  {day:23, type:'Tempo',    title:'Tempo 12‚Äì15 menit',           pace:'6:05‚Äì6:20', block:'key'},
  // WEEK 4 (24‚Äì31)
  {day:24, type:'Easy',     title:'Easy Run',                    pace:'7:10‚Äì7:40', block:'support'},
  {day:25, type:'Interval', title:'Interval 6√ó200m',             pace:'5:00‚Äì5:20', block:'key'},
  {day:26, type:'Interval', title:'Interval 4‚Äì6√ó400m',           pace:'5:05‚Äì5:20', block:'key'},
  {day:27, type:'Long',     title:'Long Run 8‚Äì9 km',             pace:'7:00‚Äì7:30', block:'key'},
  {day:28, type:'Rest',     title:'Rest Day',                    pace:'-',         block:'rest'},
  {day:29, type:'Strength', title:'Strength 20‚Äì25 menit (ringan)',pace:'-',        block:'support'},
  {day:30, type:'Tempo',    title:'Tempo 2√ó10 menit',            pace:'6:00‚Äì6:10', block:'key'},
  {day:31, type:'Interval', title:'Final Test 1 km',             pace:'4:50‚Äì5:20', block:'key'}
];

/* ===== GLOBAL STORAGE ===== */
const LOG_STORES = {};    // per planId
const ROUTE_STORES = {};  // per planId
let ENTRIES = [];         // gabungan semua plan
let currentFilter = 'all';
let currentShoeFilter = 'all';
const mapStates = {};     // key: planId_day

/* ===== UTIL ===== */
function formatPace(sec){
  if(sec==null || isNaN(sec) || sec <= 0) return '-';
  const total = Math.round(sec);
  const m = Math.floor(total/60);
  const s = total%60;
  return m+':' + (s<10?'0'+s:s);
}
function formatDuration(sec){
  if(sec==null || isNaN(sec) || sec < 0) return '-';
  const total = Math.round(sec);
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  const s = total%60;
  if(h>0) return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  return `${m}:${s.toString().padStart(2,'0')}`;
}
function typeClass(type){
  if(type==='Easy') return 'easy';
  if(type==='Tempo') return 'tempo';
  if(type==='Interval') return 'interval';
  if(type==='Long') return 'long';
  if(type==='Rest') return 'rest';
  if(type==='Strength') return 'strength';
  return '';
}
function typeLabelCls(type){
  if(type==='Easy') return 'type-easy';
  if(type==='Tempo') return 'type-tempo';
  if(type==='Interval') return 'type-interval';
  if(type==='Long') return 'type-long';
  if(type==='Rest') return 'type-rest';
  if(type==='Strength') return 'type-strength';
  return '';
}
function blockLabel(block){
  if(block==='key') return {cls:'pill-key',text:'Key Session'};
  if(block==='support') return {cls:'pill-support',text:'Support'};
  if(block==='rest') return {cls:'pill-rest',text:'Rest'};
  return {cls:'pill',text:'Session'};
}
function rpeLabel(rpe){
  if(rpe==='easy') return 'Santai (3‚Äì4)';
  if(rpe==='moderate') return 'Lumayan (5‚Äì6)';
  if(rpe==='hard') return 'Berat (7‚Äì8)';
  if(rpe==='crazy') return 'Meledak (9‚Äì10)';
  return '';
}
function findPlanMeta(planId, day){
  if(planId==='5K_DEC'){
    return PLAN_5K_DES.find(p=>p.day===day) || null;
  }
  // Plan 10K belum dispesifikkan ‚Üí generic saja
  return null;
}

/* ===== LOAD DATA DARI LOCALSTORAGE ===== */
function loadAllData(){
  ENTRIES = [];
  PLANS.forEach(pm=>{
    let logs = {};
    let routes = {};
    try{
      logs = JSON.parse(localStorage.getItem(pm.logsKey) || '{}');
    }catch(e){logs = {};}
    try{
      const raw = localStorage.getItem(pm.routesKey);
      routes = raw ? JSON.parse(raw) : {};
    }catch(e){routes = {};}

    LOG_STORES[pm.id] = logs;
    ROUTE_STORES[pm.id] = routes;

    Object.keys(logs).forEach(k=>{
      const day = parseInt(k,10);
      if(Number.isNaN(day)) return;
      ENTRIES.push({
        planId:pm.id,
        planLabel:pm.label,
        planOrder:pm.order,
        monthLabel:pm.monthLabel,
        day,
        log:logs[k]
      });
    });
  });

  // sort: urut per plan, lalu per hari
  ENTRIES.sort((a,b)=>{
    if(a.planOrder!==b.planOrder) return a.planOrder-b.planOrder;
    return a.day - b.day;
  });
}

/* ===== ROUTE HANDLING ===== */
function cleanLatLngArray(pts){
  if(!Array.isArray(pts)) return null;
  const cleaned = [];
  for(const p of pts){
    if(Array.isArray(p) && p.length>=2){
      const lat = Number(p[0]), lng = Number(p[1]);
      if(!isNaN(lat) && !isNaN(lng)) cleaned.push([lat,lng]);
    }else if(p && typeof p==='object' && p.lat!=null && p.lng!=null){
      const lat = Number(p.lat), lng = Number(p.lng);
      if(!isNaN(lat) && !isNaN(lng)) cleaned.push([lat,lng]);
    }
  }
  return cleaned.length ? cleaned : null;
}

function getRouteLatLngs(planId, day){
  const logs = LOG_STORES[planId] || {};
  const log = logs[day] || logs[String(day)];
  if(log && log.route){
    const cleaned = cleanLatLngArray(log.route);
    if(cleaned) return cleaned;
  }

  const rs = ROUTE_STORES[planId] || {};
  const r = rs[day] || rs[String(day)];
  if(!r) return null;
  const pts = r.latlng || r.coords || r.points || r;
  return cleanLatLngArray(pts);
}

/* ===== FILTERED ENTRIES (PLAN + SEPATU) ===== */
function getFilteredEntries(){
  return ENTRIES.filter(e=>{
    if(currentFilter!=='all' && e.planId!==currentFilter) return false;
    if(currentShoeFilter!=='all'){
      if((e.log.shoe || '') !== currentShoeFilter) return false;
    }
    return true;
  });
}

/* ===== SUMMARY ===== */
function computeStats(entries){
  let totalDist = 0;
  let bestPace = null;
  let sumHR = 0, countHR = 0;
  let hardCount = 0;
  const shoeDist = {};

  entries.forEach(e=>{
    const {log,planId,day} = e;
    const meta = findPlanMeta(planId,day);

    if(log.dist!=null && !isNaN(log.dist)) totalDist += log.dist;
    if(log.paceSec!=null && !isNaN(log.paceSec)){
      if(bestPace==null || log.paceSec<bestPace) bestPace = log.paceSec;
    }
    if(log.hr!=null && !isNaN(log.hr)){ sumHR+=log.hr; countHR++; }

    const isHardType = meta && (meta.type==='Tempo' || meta.type==='Interval');
    const isHardRpe = log.rpe==='hard' || log.rpe==='crazy';
    if(isHardType || isHardRpe) hardCount++;

    if(log.shoe){
      const d = log.dist!=null && !isNaN(log.dist) ? log.dist : 0;
      shoeDist[log.shoe] = (shoeDist[log.shoe] || 0) + d;
    }
  });

  return {totalDist,bestPace,avgHR:countHR?Math.round(sumHR/countHR):null,hardCount,shoeDist};
}

/* WEEKLY MILEAGE PEAK */
function getWeekIndexForPlan(planId, day){
  if(planId==='5K_DEC'){
    return Math.floor((day-3)/7); // 3‚Äì9, 10‚Äì16, dst
  }
  // default: minggu berbasis 1‚Äì7, 8‚Äì14, dst
  return Math.floor((day-1)/7);
}
function getWeekRangeForPlan(planMeta, weekIdx){
  const baseStart = (planMeta && planMeta.id==='5K_DEC') ? 3 : 1;
  const startDay = baseStart + weekIdx*7;
  const endDay = Math.min(31,startDay+6);
  const month = planMeta ? planMeta.monthLabel : '';
  return {startDay,endDay,monthLabel:month};
}
function computePeakWeek(planId, entriesForPlan){
  const weekDist = {};
  entriesForPlan.forEach(e=>{
    const {log,day} = e;
    if(log.dist==null || isNaN(log.dist)) return;
    const wIdx = getWeekIndexForPlan(planId,day);
    weekDist[wIdx] = (weekDist[wIdx] || 0) + log.dist;
  });
  const weekKeys = Object.keys(weekDist);
  if(!weekKeys.length) return null;
  let bestIdx = null;
  let bestDist = 0;
  weekKeys.forEach(k=>{
    const idx = parseInt(k,10);
    const d = weekDist[k];
    if(d>bestDist){
      bestDist = d;
      bestIdx = idx;
    }
  });
  if(bestIdx==null) return null;
  const pm = PLANS.find(p=>p.id===planId) || {id:planId,monthLabel:''};
  const range = getWeekRangeForPlan(pm,bestIdx);
  return {
    weekIndex:bestIdx,
    dist:bestDist,
    startDay:range.startDay,
    endDay:range.endDay,
    monthLabel:range.monthLabel
  };
}

/* ===== SHOE FILTER UI ===== */
function renderShoeFilter(){
  const strip = document.getElementById('shoeFilterStrip');
  if(!strip) return;
  const shoeNames = Array.from(new Set(
    ENTRIES.map(e=>e.log.shoe).filter(Boolean)
  ));
  if(!shoeNames.length){
    strip.style.display = 'none';
    return;
  }
  strip.style.display = 'flex';
  let html = '<span class="filter-label">SEPATU</span>';
  html += '<button class="filter-chip shoe-chip filter-active" data-shoe="all">Semua</button>';
  shoeNames.forEach(name=>{
    const safe = String(name).replace(/"/g,'&quot;');
    html += `<button class="filter-chip shoe-chip" data-shoe="${safe}">${safe}</button>`;
  });
  strip.innerHTML = html;
}

/* ===== SUMMARY RENDER ===== */
function renderSummary(){
  const summaryEl = document.getElementById('summary');
  const filtered = getFilteredEntries();
  summaryEl.innerHTML = '';

  if(filtered.length===0){
    summaryEl.innerHTML = `<span class="badge">Belum ada sesi untuk filter ini.</span>`;
    return;
  }

  const stats = computeStats(filtered);
  const badges = [];

  badges.push(`<span class="badge badge-strong">Total ${filtered.length} sesi ‚Ä¢ ${stats.totalDist.toFixed(1)} km</span>`);
  if(stats.bestPace){
    badges.push(`<span class="badge">Best pace: ${formatPace(stats.bestPace)} /km</span>`);
  }
  if(stats.avgHR){
    badges.push(`<span class="badge">Rata-rata HR: ${stats.avgHR} bpm</span>`);
  }
  if(stats.hardCount>4){
    badges.push(`<span class="badge badge-warn">Sesi keras: ${stats.hardCount}√ó ‚Ä¢ jaga recovery ya</span>`);
  }else if(stats.hardCount>0){
    badges.push(`<span class="badge">Sesi keras: ${stats.hardCount}√ó ‚Ä¢ balance oke</span>`);
  }

  // Per-plan badges + peak week
  if(currentFilter==='all'){
    PLANS.forEach(pm=>{
      const planEntries = filtered.filter(e=>e.planId===pm.id);
      if(!planEntries.length) return;
      const st = computeStats(planEntries);
      const peak = computePeakWeek(pm.id,planEntries);
      if(peak && peak.dist>0){
        badges.push(
          `<span class="badge badge-plan">${pm.short}: ${st.totalDist.toFixed(1)} km ‚Ä¢ ${planEntries.length} sesi ‚Ä¢ Minggu tertinggi ${peak.startDay}‚Äì${peak.endDay} ${peak.monthLabel} (${peak.dist.toFixed(1)} km)</span>`
        );
      }else{
        badges.push(
          `<span class="badge badge-plan">${pm.short}: ${st.totalDist.toFixed(1)} km ‚Ä¢ ${planEntries.length} sesi</span>`
        );
      }
    });
  }else{
    const pm = PLANS.find(p=>p.id===currentFilter);
    if(pm){
      const planEntries = filtered;
      const peak = computePeakWeek(pm.id,planEntries);
      if(peak && peak.dist>0){
        badges.push(
          `<span class="badge badge-plan">Minggu mileage tertinggi: ${peak.startDay}‚Äì${peak.endDay} ${peak.monthLabel} ‚Ä¢ ${peak.dist.toFixed(1)} km</span>`
        );
      }
    }
  }

  summaryEl.innerHTML = badges.join('');
}

/* ===== TIMELINE RENDER ===== */
function renderTimeline(){
  const timelineEl = document.getElementById('timeline');
  const emptyEl = document.getElementById('emptyState');

  // bersihkan map lama
  Object.keys(mapStates).forEach(key=>{
    const st = mapStates[key];
    if(st && st.map){
      st.map.remove();
    }
    delete mapStates[key];
  });

  const filtered = getFilteredEntries();

  if(filtered.length===0){
    emptyEl.style.display = 'block';
    timelineEl.innerHTML = '';
    return;
  }
  emptyEl.style.display = 'none';

  let html = '';
  filtered.forEach(e=>{
    const {planId,planLabel,monthLabel,day,log} = e;
    const meta = findPlanMeta(planId,day);

    const type = meta ? meta.type : 'Session';
    const title = meta ? meta.title : `Logged Session ‚Äî ${planLabel}`;
    const targetPace = meta ? meta.pace : '-';
    const block = meta ? meta.block : null;

    const pace = log.paceSec!=null? formatPace(log.paceSec)+' /km':'-';
    const dist = (log.dist!=null && !isNaN(log.dist))? log.dist.toFixed(2)+' km':'-';
    const hr   = (log.hr!=null && !isNaN(log.hr))? log.hr+' bpm':'-';
    const time = log.timeSec!=null? formatDuration(log.timeSec):'-';
    const rpe  = rpeLabel(log.rpe);
    const shoe = log.shoe || '';
    const note = log.note || '';

    const tClass = typeClass(type);
    const tLblCls = typeLabelCls(type);
    const blockInfo = blockLabel(block);

    const mapId = `map-${planId}-${day}`;
    const statusId = `map-status-${planId}-${day}`;
    const hasRoute = !!getRouteLatLngs(planId,day);

    let comment = '';
    if(meta){
      if(meta.type==='Easy'){
        if(log.paceSec && log.paceSec<360){
          comment = 'Easy-nya udah mirip tempo ü§£ turunin dikit gapapa, yang penting besok masih bisa lari.';
        }else{
          comment = 'Easy run yang beneran easy. Ini sesi yang diam-diam bikin engine kamu makin kuat.';
        }
      }else if(meta.type==='Tempo'){
        comment = 'Tempo ini yang pelan-pelan dorong pace 5 kecil jadi kenyataan. Konsistensi > sekali kenceng.';
      }else if(meta.type==='Interval'){
        comment = 'Interval bikin kaki kenal pace cepat. Jangan lupa pairing dengan easy run yang cukup.';
      }else if(meta.type==='Long'){
        comment = 'Long run = tabungan endurance. Jaraknya nggak harus ekstrem, yang penting stabil.';
      }else if(meta.type==='Rest'){
        comment = 'Rest day dicatat. Recovery itu bagian dari program, bukan tanda malas.';
      }else if(meta.type==='Strength'){
        comment = 'Strength session = investasi buat kaki, core, dan pinggul. Ini yang jaga badan tetap tahan banting.';
      }
    }else{
      comment = 'Sesi dari log plan ini. Detail jenis sesi nggak tersimpan, tapi datanya tetap kepake buat lihat progres.';
    }
    if(rpe){
      comment += ` Feeling: ${rpe}.`;
    }

    // SPLITS PER KM (KM sendiri, bar sendiri)
    let splitsHtml = '';
    if (Array.isArray(log.splits) && log.splits.length) {
      const paceVals = log.splits
        .map(s => s.paceSec)
        .filter(v => v != null && !isNaN(v) && v > 0);

      const minPace = paceVals.length ? Math.min(...paceVals) : null; // tercepat
      const maxPace = paceVals.length ? Math.max(...paceVals) : null; // terlambat

      const items = log.splits.map(s => {
        const km = s.km;
        const paceSec = s.paceSec;
        const paceStr = formatPace(paceSec);

        let bandClass = 'split-band-mid'; // default ungu
        let widthPercent = 100;

        if (minPace != null && maxPace != null &&
            paceSec != null && !isNaN(paceSec) && paceSec > 0) {

          const spread = (maxPace - minPace) || 1;
          const rawRatio = (paceSec - minPace) / spread; // 0 = cepat, 1 = lambat
          const ratio = Math.max(0, Math.min(1, rawRatio));

          if (ratio <= 0.33) {
            bandClass = 'split-band-fast';   // biru: cepat
          } else if (ratio >= 0.66) {
            bandClass = 'split-band-slow';   // merah: pelan
          } else {
            bandClass = 'split-band-mid';    // ungu: mid
          }

          // Panjang bar ala Strava: cepat = panjang, pelan = pendek
          widthPercent = 60 + (1 - ratio) * 40; // 60‚Äì100%
        }

        return `
          <div class="splits-line">
            <span class="splits-km">KM ${km}</span>
            <div class="splits-bar-shell ${bandClass}" style="--bar-fill:${widthPercent}%">
              <div class="splits-bar-core"></div>
            </div>
            <span class="splits-pace">${paceStr} /km</span>
          </div>
        `;
      }).join('');

      splitsHtml = `
        <div class="splits">
          <div class="splits-title">Split per km</div>
          <div class="splits-row">
            ${items}
          </div>
        </div>
      `;
    }

    html += `
      <div class="item">
        <div class="item-dot ${tClass}"></div>
        <div class="card">
          <div class="card-header">
            <div>
              <div class="date-label">${day} ${monthLabel} ‚Ä¢ ${meta ? type : planLabel}</div>
              <div class="type-label ${tLblCls}">
                ${title}
                <span>Target: ${targetPace}</span>
              </div>
            </div>
            <div class="pill ${blockInfo.cls}">${blockInfo.text}</div>
          </div>
          <div class="card-body">
            <div class="target">Target coach: ${targetPace}</div>
            <div class="row">
              <span><span class="label">Jarak:</span> ${dist}</span>
              <span><span class="label">Waktu:</span> ${time}</span>
              <span><span class="label">Pace:</span> ${pace}</span>
              <span><span class="label">HR:</span> ${hr}</span>
            </div>
            ${(shoe || rpe) ? `
              <div class="row">
                ${shoe ? `<span><span class="label">Sepatu:</span> ${shoe}</span>` : ''}
                ${rpe ? `<span><span class="label">RPE:</span> ${rpe}</span>` : ''}
              </div>
            ` : ''}
            <div class="comment">
              ${comment}
              ${note ? `<br><span class="label">Catatan:</span> ${note}` : ''}
            </div>
            ${splitsHtml}
            <div class="mini-map-wrap">
              <div class="map-controls">
                <button class="map-btn anim-btn" data-plan="${planId}" data-day="${day}" ${hasRoute ? '' : 'disabled'}>
                  ${hasRoute ? '‚ñ∂ Animate Route' : 'No TCX route'}
                </button>
                <div class="map-status" id="${statusId}">
                  ${hasRoute ? 'Idle ‚Ä¢ siap dianimasikan' : 'Belum ada route tersimpan'}
                </div>
              </div>
              <div class="mini-map" id="${mapId}">
                ${hasRoute ? '' : '<div class="map-placeholder">Upload TCX di kalender plan supaya route hari ini muncul di sini.</div>'}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  timelineEl.innerHTML = html;

  // init semua mini map yg punya route
  filtered.forEach(e=>{
    initMiniMap(e.planId,e.day);
  });
}


/* ===== MINI MAP + ANIMASI (DARK MAP + GLOW ROUTE) ===== */
function initMiniMap(planId, day){
  const latlngs = getRouteLatLngs(planId,day);
  const mapEl = document.getElementById(`map-${planId}-${day}`);
  if(!mapEl || !latlngs || !latlngs.length) return;

  const map = L.map(mapEl, {
    zoomControl:false,
    attributionControl:false,
    dragging:false,
    scrollWheelZoom:false,
    doubleClickZoom:false,
    boxZoom:false,
    keyboard:false
  });

  // üåë DARK MAP ‚Äì lebih nyatu sama tema cyberpunk
  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
    {
      maxZoom: 19,
      subdomains: 'abcd'
    }
  ).addTo(map);

  // Base route (garis tipis statis, selalu kelihatan)
  const basePoly = L.polyline(latlngs, {
    color:'#444c88',
    weight:2,
    opacity:0.7
  }).addTo(map);

  // Glow route (untuk animasi)
  const glowPoly = L.polyline([], {
    color:'#00eaff',
    weight:3,
    opacity:0.95
  }).addTo(map);

  // Start marker (lime) & finish marker (magenta)
  L.circleMarker(latlngs[0], {
    radius:3,
    color:'#b0ff4d',
    fillColor:'#b0ff4d',
    fillOpacity:1
  }).addTo(map);

  if(latlngs.length > 1){
    L.circleMarker(latlngs[latlngs.length-1], {
      radius:3,
      color:'#ff4dff',
      fillColor:'#ff4dff',
      fillOpacity:1
    }).addTo(map);
  }

  // Auto zoom ke seluruh rute
  map.fitBounds(L.latLngBounds(latlngs), { padding:[6,6] });

  const key = `${planId}_${day}`;
  mapStates[key] = {
    map,
    basePoly,
    glowPoly,
    latlngs,
    playing:false,
    idx:0,
    rafId:null
  };
}

function startAnimation(planId, day, btn){
  const key = `${planId}_${day}`;
  const st = mapStates[key];
  if(!st || !st.latlngs || !st.latlngs.length) return;

  // Reset glow poly ke titik awal saja
  st.glowPoly.setLatLngs([st.latlngs[0]]);
  st.idx = 1;
  st.playing = true;

  const status = document.getElementById(`map-status-${planId}-${day}`);
  if(status) status.textContent = 'Playing ‚Ä¢ animasi route berjalan...';
  btn.textContent = '‚è∏ Stop';

  if(st.rafId) cancelAnimationFrame(st.rafId);

  const step = ()=>{
    if(!st.playing) return;

    if(st.idx >= st.latlngs.length){
      st.playing = false;
      st.rafId = null;
      btn.textContent = '‚ñ∂ Replay';
      if(status) status.textContent = 'Selesai ‚Ä¢ route full tergambar';
      return;
    }

    const pts = st.glowPoly.getLatLngs();
    pts.push(st.latlngs[st.idx]);
    st.glowPoly.setLatLngs(pts);
    st.idx++;

    st.rafId = requestAnimationFrame(step);
  };

  st.rafId = requestAnimationFrame(step);
}

function stopAnimation(planId, day, btn){
  const key = `${planId}_${day}`;
  const st = mapStates[key];
  if(!st) return;

  st.playing = false;
  if(st.rafId) cancelAnimationFrame(st.rafId);
  st.rafId = null;

  const status = document.getElementById(`map-status-${planId}-${day}`);
  if(status) status.textContent = 'Paused ‚Ä¢ bisa lanjut lagi atau replay dari awal';
  btn.textContent = '‚ñ∂ Resume';
}
  
/* ===== EVENT HANDLER ===== */
document.addEventListener('click', e=>{
  // PLAN FILTER
  const planChip = e.target.closest('.filter-chip[data-filter]');
  if(planChip){
    const val = planChip.dataset.filter;
    if(val){
      currentFilter = val;
      document.querySelectorAll('.filter-chip[data-filter]').forEach(c=>c.classList.remove('filter-active'));
      planChip.classList.add('filter-active');
      renderSummary();
      renderTimeline();
    }
    return;
  }

  // SHOE FILTER
  const shoeChip = e.target.closest('.filter-chip[data-shoe]');
  if(shoeChip){
    const val = shoeChip.dataset.shoe || 'all';
    currentShoeFilter = val;
    document.querySelectorAll('.filter-chip[data-shoe]').forEach(c=>c.classList.remove('filter-active'));
    shoeChip.classList.add('filter-active');
    renderSummary();
    renderTimeline();
    return;
  }

  // animasi mini map
  const btn = e.target.closest('.anim-btn');
  if(btn){
    if(btn.disabled) return;
    const planId = btn.dataset.plan;
    const day = Number(btn.dataset.day);
    const key = `${planId}_${day}`;
    const st = mapStates[key];
    if(!st){
      const status = document.getElementById(`map-status-${planId}-${day}`);
      if(status) status.textContent = 'Route belum tersedia / gagal dibaca.';
      return;
    }
    if(!st.playing){
      startAnimation(planId,day,btn);
    }else{
      stopAnimation(planId,day,btn);
    }
  }
});

/* ===== MODAL PILIH PLAN ===== */
const planModal = document.getElementById('planModal');
const backBtn = document.getElementById('backToCalendar');
const modalCloseBtn = document.getElementById('planModalClose');

backBtn.addEventListener('click', ()=>{
  planModal.classList.add('show');
});
modalCloseBtn.addEventListener('click', ()=>{
  planModal.classList.remove('show');
});
planModal.addEventListener('click', (e)=>{
  if(e.target === planModal){
    planModal.classList.remove('show');
  }
});
document.querySelectorAll('.plan-option-btn[data-target]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = btn.getAttribute('data-target');
    if(target) window.location.href = target;
  });
});

/* ===== INIT ===== */
(function init(){
  loadAllData();
  renderShoeFilter();
  renderSummary();
  renderTimeline();
})();
  const SHARED_STORAGE_KEY = 'RAMA_RUNNA_TIMELINE_V1';

function saveSessionToSharedStorage(summary){
  try{
    const raw = localStorage.getItem(SHARED_STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];

    arr.push({
      ...summary,
      createdAt: new Date().toISOString()
    });

    localStorage.setItem(SHARED_STORAGE_KEY, JSON.stringify(arr));
  }catch(e){
    console.warn('Gagal simpan session ke storage bersama', e);
  }
}
</script>

</body>
</html>


